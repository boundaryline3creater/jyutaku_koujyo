import React, { useState } from 'react';
import { 
  ChevronRight, 
  ChevronLeft, 
  Download, 
  Home, 
  MapPin, 
  FileText,
  CreditCard,
  PlusCircle,
  Users
} from 'lucide-react';

// コンポーネントの外に定義することで再レンダリング時のフォーカス消失を防ぐ
const InputField = ({ label, value, onChange, placeholder = "0", type = "text", unit = "" }) => (
  <div className="mb-4">
    <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>
    <div className="relative">
      <input
        type={type}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base"
      />
      {unit && <span className="absolute right-3 top-3 text-gray-400 text-sm">{unit}</span>}
    </div>
  </div>
);

const RadioGroup = ({ label, options, value, onChange }) => (
  <div className="mb-4">
    <label className="block text-sm font-bold text-gray-700 mb-2">{label}</label>
    <div className="grid grid-cols-1 gap-2">
      {options.map((opt) => (
        <button
          key={opt.value}
          onClick={() => onChange(opt.value)}
          className={`px-4 py-3 rounded-xl border text-left text-sm transition-all ${
            value === opt.value 
              ? 'bg-blue-50 border-blue-600 text-blue-700 ring-1 ring-blue-600' 
              : 'bg-white border-gray-300 text-gray-600'
          }`}
        >
          <div className="flex items-center gap-2">
            <div className={`w-4 h-4 rounded-full border flex items-center justify-center ${value === opt.value ? 'border-blue-600' : 'border-gray-400'}`}>
              {value === opt.value && <div className="w-2 h-2 bg-blue-600 rounded-full" />}
            </div>
            {opt.label}
          </div>
        </button>
      ))}
    </div>
  </div>
);

const SectionHeader = ({ icon: Icon, title, colorClass = "text-blue-600" }) => (
  <div className="flex items-center gap-2 mb-6 mt-8 border-b-2 pb-2 border-gray-100">
    <Icon className={`w-6 h-6 ${colorClass}`} />
    <h2 className={`text-lg font-black ${colorClass}`}>{title}</h2>
  </div>
);

const DateInput = ({ label, data, onChangeDate }) => (
  <div className="mb-4">
    <label className="block text-sm font-bold text-gray-700 mb-1">{label} (令和)</label>
    <div className="flex gap-2">
      <div className="flex-1 flex items-center gap-1">
        <input type="number" value={data.year} onChange={(e) => onChangeDate('year', e.target.value)} className="w-full p-2 border rounded text-center" placeholder="7" />
        <span className="text-xs">年</span>
      </div>
      <div className="flex-1 flex items-center gap-1">
        <input type="number" value={data.month} onChange={(e) => onChangeDate('month', e.target.value)} className="w-full p-2 border rounded text-center" placeholder="1" />
        <span className="text-xs">月</span>
      </div>
      <div className="flex-1 flex items-center gap-1">
        <input type="number" value={data.day} onChange={(e) => onChangeDate('day', e.target.value)} className="w-full p-2 border rounded text-center" placeholder="1" />
        <span className="text-xs">日</span>
      </div>
    </div>
  </div>
);

const YesNoInput = ({ label, data, onToggle, onValueChange }) => (
  <div className="mb-4 p-3 bg-gray-50 rounded-xl">
    <label className="block text-sm font-bold text-gray-700 mb-2">{label}</label>
    <div className="flex gap-4 mb-2">
      <label className="flex items-center gap-1">
        <input type="radio" checked={data.has === true} onChange={() => onToggle(true)} /> 有
      </label>
      <label className="flex items-center gap-1">
        <input type="radio" checked={data.has === false} onChange={() => onToggle(false)} /> 無
      </label>
    </div>
    {data.has && (
      <InputField label="金額" value={data.value} onChange={onValueChange} unit="円" type="number" />
    )}
  </div>
);

const FractionInput = ({ label, data, onChangeFraction }) => (
  <div className="mb-4">
    <label className="block text-sm font-bold text-gray-700 mb-1">{label} (持分)</label>
    <div className="flex items-center gap-2">
      <input type="text" value={data.numerator} onChange={(e) => onChangeFraction('numerator', e.target.value)} className="w-full p-2 border rounded text-center" placeholder="分子" />
      <span>/</span>
      <input type="text" value={data.denominator} onChange={(e) => onChangeFraction('denominator', e.target.value)} className="w-full p-2 border rounded text-center" placeholder="分母" />
    </div>
  </div>
);

const App = () => {
  const [step, setStep] = useState('input');
  const [formData, setFormData] = useState({
    residenceStartDate: { year: '7', month: '', day: '' },
    houseContractDate: { year: '', month: '', day: '' },
    contractType: '', 
    acquisitionPrice: '',
    houseSubsidy: { has: false, value: '' },
    floorArea: '',
    mansionArea: '',
    propertyNumber: '',
    houseOwnership: { numerator: '', denominator: '' },
    houseGiftTax: { has: false, value: '' },
    landContractDate: { year: '', month: '', day: '' },
    landType: '', 
    landPrice: '',
    landSubsidy: { has: false, value: '' },
    landArea: '',
    mansionLandTotalArea: '',
    mansionHouseTotalArea: '',
    landOwnership: { numerator: '', denominator: '' },
    landGiftTax: { has: false, value: '' },
    loanType: '', 
    initialLoanAmountHouse: '',
    initialLoanAmountLand: '',
    yearEndBalanceHouse: '',
    yearEndBalanceLand: '',
    jointDebtHouse: { has: false, selfFunds: '' },
    jointDebtLand: { has: false, selfFunds: '' }
  });

  const updateField = (path, value) => {
    const keys = path.split('.');
    if (keys.length === 1) {
      setFormData(prev => ({ ...prev, [keys[0]]: value }));
    } else {
      setFormData(prev => ({
        ...prev,
        [keys[0]]: { ...prev[keys[0]], [keys[1]]: value }
      }));
    }
  };

  const formatAmount = (val) => val ? `${Number(val).toLocaleString()}円` : '0円';
  const formatDate = (d) => `令和${d.year || '-'}年${d.month || '-'}月${d.day || '-'}日`;
  const formatFraction = (f) => f.numerator && f.denominator ? `${f.numerator} / ${f.denominator}` : '-';

  if (step === 'confirm') {
    return (
      <div className="min-h-screen bg-gray-100 pb-24 p-4">
        <div className="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden print:shadow-none print:m-0 print:w-full">
          <div className="bg-slate-800 p-6 text-white flex justify-between items-center print:bg-white print:text-black print:border-b print:py-4">
            <div>
              <h1 className="text-xl font-bold">住宅ローン控除入力メモ（確認）</h1>
              <p className="text-xs text-slate-400 mt-1 print:hidden">内容を確認してPDF保存してください</p>
            </div>
            <button onClick={() => setStep('input')} className="text-sm bg-slate-700 px-4 py-2 rounded-xl active:scale-95 transition-all print:hidden">
              <div className="flex items-center gap-1"><ChevronLeft className="w-4 h-4" /> 修正</div>
            </button>
          </div>
          
          <div className="p-6 space-y-8 max-h-[75vh] overflow-y-auto print:max-h-none print:overflow-visible">
            {/* 住宅に関する事項 */}
            <section>
              <h3 className="flex items-center gap-2 font-black text-blue-600 border-b-2 border-blue-50 pb-2 mb-4">
                <Home className="w-5 h-5" /> 住宅に関する事項
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-6 text-sm">
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">居住開始年月日</span>
                  <span className="font-bold">{formatDate(formData.residenceStartDate)}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">契約年月日</span>
                  <span className="font-bold">{formatDate(formData.houseContractDate)}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">契約区分</span>
                  <span className="font-bold">{formData.contractType || '-'}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">取得対価の額</span>
                  <span className="font-bold text-blue-700">{formatAmount(formData.acquisitionPrice)}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">交付を受ける補助金等</span>
                  <span className="font-bold">{formData.houseSubsidy.has ? formatAmount(formData.houseSubsidy.value) : '無'}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">総(床)面積 / 専有面積</span>
                  <span className="font-bold">{formData.floorArea || '-'}㎡ / {formData.mansionArea || '-'}㎡</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">不動産番号</span>
                  <span className="font-bold tracking-wider">{formData.propertyNumber || '-'}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">自己の持分</span>
                  <span className="font-bold">{formatFraction(formData.houseOwnership)}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1 md:col-span-2">
                  <span className="text-slate-400 text-xs">贈与特例を受けた金額</span>
                  <span className="font-bold">{formData.houseGiftTax.has ? formatAmount(formData.houseGiftTax.value) : '無'}</span>
                </div>
              </div>
            </section>

            {/* 土地に関する事項 */}
            <section>
              <h3 className="flex items-center gap-2 font-black text-green-600 border-b-2 border-green-50 pb-2 mb-4">
                <MapPin className="w-5 h-5" /> 土地に関する事項
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-6 text-sm">
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">土地の契約年月日</span>
                  <span className="font-bold">{formatDate(formData.landContractDate)}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">土地の取得区分</span>
                  <span className="font-bold">{formData.landType || '-'}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">土地の取得対価</span>
                  <span className="font-bold text-green-700">{formatAmount(formData.landPrice)}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">土地の補助金等</span>
                  <span className="font-bold">{formData.landSubsidy.has ? formatAmount(formData.landSubsidy.value) : '無'}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">土地の面積</span>
                  <span className="font-bold">{formData.landArea || '-'} ㎡</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1">
                  <span className="text-slate-400 text-xs">土地の持分</span>
                  <span className="font-bold">{formatFraction(formData.landOwnership)}</span>
                </div>
                <div className="flex flex-col border-b border-slate-50 pb-1 p-2 bg-slate-50 rounded md:col-span-2">
                  <span className="text-slate-400 text-xs">マンション用（1棟の面積）</span>
                  <span className="font-bold">土地：{formData.mansionLandTotalArea || '-'} ㎡ / 住宅：{formData.mansionHouseTotalArea || '-'} ㎡</span>
                </div>
              </div>
            </section>

            {/* 借入金等の内訳 */}
            <section>
              <h3 className="flex items-center gap-2 font-black text-orange-600 border-b-2 border-orange-50 pb-2 mb-4">
                <CreditCard className="w-5 h-5" /> 住宅借入金等の内訳
              </h3>
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div className="bg-slate-50 p-3 rounded-xl">
                    <p className="text-xs text-slate-400 mb-1">当初金額 (住宅)</p>
                    <p className="font-bold">{formatAmount(formData.initialLoanAmountHouse)}</p>
                  </div>
                  <div className="bg-slate-50 p-3 rounded-xl">
                    <p className="text-xs text-slate-400 mb-1">当初金額 (土地)</p>
                    <p className="font-bold">{formatAmount(formData.initialLoanAmountLand)}</p>
                  </div>
                  <div className="bg-orange-50 p-3 rounded-xl ring-1 ring-orange-100">
                    <p className="text-xs text-orange-400 mb-1 font-bold italic">年末残高 (住宅)</p>
                    <p className="font-black text-lg text-orange-700">{formatAmount(formData.yearEndBalanceHouse)}</p>
                  </div>
                  <div className="bg-orange-50 p-3 rounded-xl ring-1 ring-orange-100">
                    <p className="text-xs text-orange-400 mb-1 font-bold italic">年末残高 (土地)</p>
                    <p className="font-black text-lg text-orange-700">{formatAmount(formData.yearEndBalanceLand)}</p>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div className="flex flex-col border-b border-slate-50 pb-1">
                    <span className="text-slate-400 text-xs">連帯債務 (住宅)</span>
                    <span className="font-bold">{formData.jointDebtHouse.has ? `有（自己資金：${formatAmount(formData.jointDebtHouse.selfFunds)}）` : '無'}</span>
                  </div>
                  <div className="flex flex-col border-b border-slate-50 pb-1">
                    <span className="text-slate-400 text-xs">連帯債務 (土地)</span>
                    <span className="font-bold">{formData.jointDebtLand.has ? `有（自己資金：${formatAmount(formData.jointDebtLand.selfFunds)}）` : '無'}</span>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>

        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t flex gap-3 print:hidden z-50">
          <button onClick={() => setStep('input')} className="flex-1 py-4 bg-slate-200 text-slate-700 font-bold rounded-2xl active:scale-95 transition-all">
            修正する
          </button>
          <button onClick={() => window.print()} className="flex-[2] py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2">
            <Download className="w-5 h-5" /> PDFとして保存
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 pb-32">
      <header className="bg-white px-6 py-5 border-b sticky top-0 z-20 shadow-sm">
        <h1 className="text-xl font-black text-slate-800 flex items-center gap-2">
          <div className="bg-blue-600 w-2 h-6 rounded-full"></div>
          住宅ローン控除入力メモ
        </h1>
      </header>

      <main className="max-w-2xl mx-auto px-4">
        <div className="bg-white mt-4 rounded-3xl p-6 shadow-sm border border-slate-100">
          
          <SectionHeader icon={Home} title="住宅に関する事項" colorClass="text-blue-600" />
          <DateInput label="居住開始年月日" data={formData.residenceStartDate} onChangeDate={(k, v) => updateField(`residenceStartDate.${k}`, v)} />
          <DateInput label="契約日" data={formData.houseContractDate} onChangeDate={(k, v) => updateField(`houseContractDate.${k}`, v)} />
          <RadioGroup 
            label="契約区分" 
            options={[{label:'新築等', value:'新築等'}, {label:'買取再販', value:'買取再販'}, {label:'中古', value:'中古'}]} 
            value={formData.contractType} 
            onChange={(v)=>updateField('contractType', v)} 
          />
          <InputField label="取得対価の額" value={formData.acquisitionPrice} onChange={(v)=>updateField('acquisitionPrice', v)} unit="円" type="number" />
          <YesNoInput 
            label="交付を受ける補助金等" 
            data={formData.houseSubsidy} 
            onToggle={(v) => updateField('houseSubsidy.has', v)}
            onValueChange={(v) => updateField('houseSubsidy.value', v)}
          />
          <InputField label="総(床)面積" value={formData.floorArea} onChange={(v)=>updateField('floorArea', v)} unit="㎡" />
          <InputField label="自己の専有部分の床面積 (マンション)" value={formData.mansionArea} onChange={(v)=>updateField('mansionArea', v)} unit="㎡" />
          <InputField label="不動産番号" value={formData.propertyNumber} onChange={(v)=>updateField('propertyNumber', v)} placeholder="13桁程度" />
          <FractionInput label="自己の持分 (共有名義)" data={formData.houseOwnership} onChangeFraction={(k, v) => updateField(`houseOwnership.${k}`, v)} />
          <YesNoInput 
            label="贈与の特例を受けた金額等" 
            data={formData.houseGiftTax} 
            onToggle={(v) => updateField('houseGiftTax.has', v)}
            onValueChange={(v) => updateField('houseGiftTax.value', v)}
          />

          <SectionHeader icon={MapPin} title="土地に関する事項" colorClass="text-green-600" />
          <DateInput label="土地の契約日" data={formData.landContractDate} onChangeDate={(k, v) => updateField(`landContractDate.${k}`, v)} />
          <RadioGroup 
            label="土地の取得区分" 
            options={[
              {label:'土地付きの新築住宅の購入', value:'土地付き新築'},
              {label:'借入金等により購入した後に住宅を新築', value:'先行購入'}
            ]} 
            value={formData.landType} 
            onChange={(v)=>updateField('landType', v)} 
          />
          <InputField label="土地の取得対価" value={formData.landPrice} onChange={(v)=>updateField('landPrice', v)} unit="円" type="number" />
          <YesNoInput 
            label="土地の補助金等" 
            data={formData.landSubsidy} 
            onToggle={(v) => updateField('landSubsidy.has', v)}
            onValueChange={(v) => updateField('landSubsidy.value', v)}
          />
          <InputField label="土地の面積" value={formData.landArea} onChange={(v)=>updateField('landArea', v)} unit="㎡" />
          <div className="p-4 bg-green-50 rounded-2xl mb-4 border border-green-100">
            <p className="text-xs font-bold text-green-700 mb-2">マンションの場合</p>
            <InputField label="1棟の土地の面積" value={formData.mansionLandTotalArea} onChange={(v)=>updateField('mansionLandTotalArea', v)} unit="㎡" />
            <InputField label="1棟の住宅の総床面積" value={formData.mansionHouseTotalArea} onChange={(v)=>updateField('mansionHouseTotalArea', v)} unit="㎡" />
          </div>
          <FractionInput label="土地の自己持分" data={formData.landOwnership} onChangeFraction={(k, v) => updateField(`landOwnership.${k}`, v)} />

          <SectionHeader icon={CreditCard} title="住宅借入金等の内訳" colorClass="text-orange-600" />
          <RadioGroup 
            label="内訳区分" 
            options={[{label:'住宅のみ', value:'住宅のみ'}, {label:'住宅及び土地等', value:'住宅及び土地等'}, {label:'土地等のみ', value:'土地等のみ'}]} 
            value={formData.loanType} 
            onChange={(v)=>updateField('loanType', v)} 
          />
          <div className="grid grid-cols-1 gap-4">
            <InputField label="当初金額 (住宅)" value={formData.initialLoanAmountHouse} onChange={(v)=>updateField('initialLoanAmountHouse', v)} unit="円" type="number" />
            <InputField label="当初金額 (土地)" value={formData.initialLoanAmountLand} onChange={(v)=>updateField('initialLoanAmountLand', v)} unit="円" type="number" />
            <InputField label="年末残高 (住宅)" value={formData.yearEndBalanceHouse} onChange={(v)=>updateField('yearEndBalanceHouse', v)} unit="円" type="number" />
            <InputField label="年末残高 (土地)" value={formData.yearEndBalanceLand} onChange={(v)=>updateField('yearEndBalanceLand', v)} unit="円" type="number" />
          </div>
          
          <div className="mt-6 space-y-4">
            <YesNoInput 
              label="連帯債務 (住宅)" 
              data={formData.jointDebtHouse} 
              onToggle={(v) => updateField('jointDebtHouse.has', v)}
              onValueChange={(v) => updateField('jointDebtHouse.value', v)}
            />
            <YesNoInput 
              label="連帯債務 (土地)" 
              data={formData.jointDebtLand} 
              onToggle={(v) => updateField('jointDebtLand.has', v)}
              onValueChange={(v) => updateField('jointDebtLand.value', v)}
            />
          </div>

        </div>
      </main>

      <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-xl border-t border-slate-200 z-30">
        <button 
          onClick={() => setStep('confirm')}
          className="w-full max-w-2xl mx-auto block py-4 bg-slate-900 text-white font-black rounded-2xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2"
        >
          入力内容を確認する
          <ChevronRight className="w-5 h-5" />
        </button>
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        @media print {
          .print\\:hidden { display: none !important; }
          body { background: white !important; margin: 0; padding: 0; }
          .max-h-\\[75vh\\] { max-height: none !important; overflow: visible !important; }
          .rounded-3xl { border-radius: 0 !important; }
          .shadow-xl { box-shadow: none !important; }
          .p-4 { padding: 0 !important; }
          .m-4 { margin: 0 !important; }
          header { display: none !important; }
        }
      `}} />
    </div>
  );
};

export default App;